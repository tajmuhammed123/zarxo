<%-include('../layouts/userHeader') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs/build/css/alertify.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs/build/css/themes/default.min.css"/>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alertifyjs/build/alertify.min.js"></script>


	<!-- Title page -->
	<section class="bg-img1 txt-center p-lr-15 p-tb-80" style="background-image: url('images/cartimg.jpg');">
		<h2 class="ltext-105 cl0 txt-center">
			Shopping Cart
		</h2>
	</section>	


	<!-- breadcrumb -->
	<div class="container">
		<div class="bread-crumb flex-w p-l-25 p-r-15 p-t-100 p-lr-0-lg">
			<a href="/dashboard" class="stext-109 cl8 hov-cl1 trans-04">
				Home
				<i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
			</a>

			<span class="stext-109 cl4">
				Shoping Cart
			</span>
		</div>
	</div>
		

	<!-- Shoping Cart -->
	<div id="reloadDiv">
		<form class="bg0 p-t-75 p-b-85">
			<div class="container">
			  <div class="row">
				<div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
				  <div class="m-l-25 m-r--38 m-lr-0-xl">
					<div class="wrap-table-shopping-cart">
						<table class="table-shopping-cart product_data quantitytotal">
							<thead>
							  <tr class="table_head">
								<th class="column-1">Product</th>
								<th class="column-2"></th>
								<th class="column-3">Price</th>
								<th class="column-4">Brand</th>
								<th class="column-5">Quantity</th>
								<th class="column-6">Total</th>
							  </tr>
							</thead>
							<tbody>
							  <% let total = 0; 
							  %>
							  <% if (products) {
								for (let i = 0; i < products.product.length; i++) {
								  const product = products.product[i];
								  const productTotal = parseFloat(product.product_price) * parseFloat(product.product_quantity);
								  total += productTotal;
							  %>
							  <tr class="table_row">
								<td class="column-1">
								<a href="#" class="deleteLink" data-productid="<%= product._id %>" data-userid="<%= userid %>">
									<div class="how-itemcart1">
									  <img src="/admin/images/<%= product.product_img %>" alt="IMG">
									</div>
								</a>
								</td>
								<td class="column-2"><%= product.product_name %></td>
								<td class="column-3">$<%= product.product_price %></td>
								<td class="column-4" style="text-transform: uppercase;"><%= product.product_brand %></td>
								<td class="column-5">
								  <div class="wrap-num-product flex-w m-l-auto m-r-0">
									<div class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m changeQuantity"
									  data-field="quantity" onclick="changeQuantity('<%= userid %>','<%= product.product_id %>', -1)">
									  <i class="fs-16 zmdi zmdi-minus"></i>
									</div>
									<input class="mtext-104 cl3 txt-center num-product qty-input quantity-field" type="number"
									  name="product_quantity" value="<%= product.product_quantity %>" data-product-id="<%= product._id %>">
									<div class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m changeQuantity"
									  data-field="quantity" onclick="changeQuantity('<%= userid %>','<%= product.product_id %>', 1)">
									  <i class="fs-16 zmdi zmdi-plus"></i>
									</div>
								  </div>
								</td>
								<td data-label="Total" class="column-6 ec-cart-pro-subtotal"><span>$<%= product.total_price %></span></td>
							  </tr>
							  <% }
							  %>
							  <tr>
								<td colspan="6">
								  <input type="hidden" name="total" value="<%= total %>">
								</td>
							  </tr>
							  <% } else { %>
							  <tr>
								<td colspan="6">Products Not found</td>
							  </tr>
							  <% }
							  %>
							</tbody>
						  </table>					  
					</div>
				  </div>
				</div>
		  
				<div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
				  <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
					<h4 class="mtext-109 cl2 p-b-30">
					  Cart Totals
					</h4>
		  
					<div class="flex-w flex-t p-t-27 p-b-33">
					  <div class="size-208">
						<span class="mtext-101 cl2">
						  Total:
						</span>
					  </div>
		  
					  <div class="size-209 p-t-1">
						<span class="mtext-110 cl2 total">
						  $<%= total.toFixed(2) %>
						</span>
					  </div>
					</div>
					<a href="/payment">
					  <div class="flex-c-m stext-101 cl2 size-119 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10">
						Proceed to Checkout
					  </div>
					</a>
				  </div>
				</div>
			  </div>
			</div>
		  </form>
	</div>
	

	<!-- Footer -->
	<footer class="bg3 p-t-75 p-b-32">
		<div class="container">
			<div class="row">
				<div class="col-sm-6 col-lg-3 p-b-50">
					<h4 class="stext-301 cl0 p-b-30">
						Categories
					</h4>

					<ul>
						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Women
							</a>
						</li>

						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Men
							</a>
						</li>

						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Shoes
							</a>
						</li>

						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Watches
							</a>
						</li>
					</ul>
				</div>

				<div class="col-sm-6 col-lg-3 p-b-50">
					<h4 class="stext-301 cl0 p-b-30">
						Help
					</h4>

					<ul>
						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Track Order
							</a>
						</li>

						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Returns 
							</a>
						</li>

						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								Shipping
							</a>
						</li>

						<li class="p-b-10">
							<a href="#" class="stext-107 cl7 hov-cl1 trans-04">
								FAQs
							</a>
						</li>
					</ul>
				</div>

				<div class="col-sm-6 col-lg-3 p-b-50">
					<h4 class="stext-301 cl0 p-b-30">
						GET IN TOUCH
					</h4>

					<p class="stext-107 cl7 size-201">
						Any questions? Let us know in store at 8th floor, 379 Hudson St, New York, NY 10018 or call us on (+1) 96 716 6879
					</p>

					<div class="p-t-27">
						<a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
							<i class="fa fa-facebook"></i>
						</a>

						<a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
							<i class="fa fa-instagram"></i>
						</a>

						<a href="#" class="fs-18 cl7 hov-cl1 trans-04 m-r-16">
							<i class="fa fa-pinterest-p"></i>
						</a>
					</div>
				</div>

				<div class="col-sm-6 col-lg-3 p-b-50">
					<h4 class="stext-301 cl0 p-b-30">
						Newsletter
					</h4>

					<form>
						<div class="wrap-input1 w-full p-b-4">
							<input class="input1 bg-none plh1 stext-107 cl7" type="text" name="email" placeholder="email@example.com">
							<div class="focus-input1 trans-04"></div>
						</div>

						<div class="p-t-18">
							<button class="flex-c-m stext-101 cl0 size-103 bg1 bor1 hov-btn2 p-lr-15 trans-04">
								Subscribe
							</button>
						</div>
					</form>
				</div>
			</div>

			<div class="p-t-40">
				<div class="flex-c-m flex-w p-b-18">
					<a href="#" class="m-all-1">
						<img src="images/icons/icon-pay-01.png" alt="ICON-PAY">
					</a>

					<a href="#" class="m-all-1">
						<img src="images/icons/icon-pay-02.png" alt="ICON-PAY">
					</a>

					<a href="#" class="m-all-1">
						<img src="images/icons/icon-pay-03.png" alt="ICON-PAY">
					</a>

					<a href="#" class="m-all-1">
						<img src="images/icons/icon-pay-04.png" alt="ICON-PAY">
					</a>

					<a href="#" class="m-all-1">
						<img src="images/icons/icon-pay-05.png" alt="ICON-PAY">
					</a>
				</div>

				<p class="stext-107 cl6 txt-center">
					<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
					Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | Made with <i class="fa fa-heart-o" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a> &amp; distributed by <a href="https://themewagon.com" target="_blank">ThemeWagon</a>
					<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->

				</p>
			</div>
		</div>
	</footer>


	<!-- Back to top -->
	<div class="btn-back-to-top" id="myBtn">
		<span class="symbol-btn-back-to-top">
			<i class="zmdi zmdi-chevron-up"></i>
		</span>
	</div>

<!--===============================================================================================-->	
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
<!--===============================================================================================-->
	<script src="vendor/animsition/js/animsition.min.js"></script>
<!--===============================================================================================-->
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
<!--===============================================================================================-->
	<script src="vendor/select2/select2.min.js"></script>
	<script>
		$(".js-select2").each(function(){
			$(this).select2({
				minimumResultsForSearch: 20,
				dropdownParent: $(this).next('.dropDownSelect2')
			});
		})
	</script>
<!--===============================================================================================-->
	<script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
<!--===============================================================================================-->
	<script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
	<script>
		$('.js-pscroll').each(function(){
			$(this).css('position','relative');
			$(this).css('overflow','hidden');
			var ps = new PerfectScrollbar(this, {
				wheelSpeed: 1,
				scrollingThreshold: 1000,
				wheelPropagation: false,
			});

			$(window).on('resize', function(){
				ps.update();
			})
		});
	</script>
<!--===============================================================================================-->
	<script src="js/main.js"></script>
	<script>
		function changeQuantity(userId, proId, count) {
		  $.ajax({
			url: '/update_cart',
			method: 'POST',
			data: {
			  user: userId,
			  product: proId,
			  count: count
			},
			success: function(response) {
			  if (response.success) {
				$('#reloadDiv').load('/cart #reloadDiv');
			  } else if (response.check) {
				swal.fire({
				  icon: 'error',
				  title: 'Oops...',
				  text: 'Out of stock'
				});
			  } else {
				swal.fire({
				  icon: 'error',
				  title: 'Oops...',
				  text: response.message
				});
			  }
			},
			error: function(error) {
			  console.log(error);
			}
		  });
		}
	  </script>	

<script>
	// Get all the delete links
	const deleteLinks = document.querySelectorAll('.deleteLink');
  
	// Add click event listener to each delete link
	deleteLinks.forEach(deleteLink => {
	  deleteLink.addEventListener('click', function(event) {
		event.preventDefault(); // Prevent the default behavior of following the link
  
		const productId = deleteLink.dataset.productid;
		const userId = deleteLink.dataset.userid;
		const url = `/deleteproduct?id=${productId}&userid=${userId}`;
  
		const options = {
		  method: 'DELETE'
		};
  
		fetch(url, options)
		  .then(response => {
			if (response.status === 200) {
			  console.log('Product deleted successfully');
			  window.location.href = `/cart?id=${userId}`;
			  // Perform any additional actions as needed
			} else {
			  console.error('Failed to delete product');
			  // Perform any error handling as needed
			}
		  })
		  .catch(error => {
			console.error('Network error:', error);
			// Perform any error handling as needed
		  });
	  });
	});
  </script>

</body>
</html>